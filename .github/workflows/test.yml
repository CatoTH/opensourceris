name: Run tests

on: [push]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
      - uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Install
        run: |
          sudo apt-get install poppler-utils
          npm ci
          pip install poetry --upgrade
          poetry install -E import-json
      - name: Test migrations
        # Ensure our migrations are working (squashing can cause weird problems)
        run: "ENV_PATH=etc/test.env poetry run python ./manage.py migrate"
      - name: Build assets
        run: |
          npm run build:prod
          npm run build:dev
      - name: Run tests
        run: "poetry run python ./manage.py test"
